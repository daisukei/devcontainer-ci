name: 'DevContainer CI' 
on: 
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout (GitHub)
        uses: actions/checkout@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2 
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}

      - name: Build and run dev container task
        uses: devcontainers/ci@v0.3
        with:
          imageName: ghcr.io/daisukei/example-devcontainer
          subFolder: '.'
          runCmd: sudo chmod 777 . || pytest --doctest-modules --junitxml=junit/test-results.xml --cov=./devcontainer-ci --cov-report=xml --cov-report=html || pwd || ls -alh
          #runCmd: sudo chmod 644 . || echo "Hello, World!" > sample.txt

      - name: List all files and folders
        run: ls -alh

      - name: runner - List all files and folders
        run: ls -alh /home/runner/work/devcontainer-ci/devcontainer-ci

      - name: mnt/output - List all files and folders
        run: ls -alh /mnt/github/output
        
      - name: Upload pytest test results
        uses: actions/upload-artifact@v3
        with:
          name: pytest-results
          path: junit/test-results.xml
        # Use always() to always run this step to publish test results when there are test failures
        if: ${{ always() }}

  call-trivy-scan:
    uses: ./.github/workflows/template_trivy_scan.yml
    with:
      sourcePath: '.'
